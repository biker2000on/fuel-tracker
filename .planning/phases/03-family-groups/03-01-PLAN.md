---
phase: 03-family-groups
plan: 01
type: execute
depends_on: []
files_modified: [prisma/schema.prisma, src/app/api/groups/route.ts]
---

<objective>
Create Group and Membership models with database relationships.

Purpose: Establish data foundation for family group sharing.
Output: Prisma schema with Group/Membership models, API to list user's groups.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./03-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@prisma/schema.prisma
@src/lib/db.ts
@src/auth.ts

**Tech stack available:**
- Next.js 16+ with App Router
- Prisma 7.x with PrismaPg adapter
- Auth.js v5 with JWT sessions
- User model with id, email, passwordHash, name

**Constraining decisions:**
- Prisma client at @/generated/prisma/client
- Auth.js v5 session includes user.id
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Group and Membership models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add Group model:
    ```prisma
    model Group {
      id         String       @id @default(cuid())
      name       String
      inviteCode String       @unique
      createdAt  DateTime     @default(now())
      updatedAt  DateTime     @updatedAt
      members    Membership[]
    }
    ```

    Add Membership model (join table with role):
    ```prisma
    model Membership {
      id       String   @id @default(cuid())
      role     String   @default("member")  // "owner" or "member"
      userId   String
      groupId  String
      joinedAt DateTime @default(now())

      user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
      group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

      @@unique([userId, groupId])  // User can only be in a group once
      @@index([userId])
      @@index([groupId])
    }
    ```

    Update User model to add membership relation:
    ```prisma
    model User {
      // ... existing fields ...
      memberships Membership[]
    }
    ```

    Run `npx prisma generate` to update types.

    Design notes:
    - inviteCode: 8-char alphanumeric for easy sharing (e.g., "ABC12DEF")
    - role: "owner" (can manage group) or "member" (can use vehicles)
    - Cascade delete: If user deleted, their memberships deleted
    - Cascade delete: If group deleted, all memberships deleted
  </action>
  <verify>npx prisma validate passes, npx prisma generate succeeds</verify>
  <done>Group and Membership models added with proper relations. Types regenerated.</done>
</task>

<task type="auto">
  <name>Task 2: Create API endpoint to list user's groups</name>
  <files>src/app/api/groups/route.ts</files>
  <action>
    Create GET /api/groups endpoint:

    1. Get current user from auth session (use auth() from src/auth.ts)
    2. If not authenticated: return 401
    3. Query memberships for current user, include group data
    4. Return array of groups with user's role in each:
       ```json
       {
         "groups": [
           {
             "id": "clx...",
             "name": "Smith Family",
             "role": "owner",
             "memberCount": 3,
             "joinedAt": "2026-01-13T..."
           }
         ]
       }
       ```

    Query pattern:
    ```typescript
    const memberships = await prisma.membership.findMany({
      where: { userId: session.user.id },
      include: {
        group: {
          include: {
            _count: { select: { members: true } }
          }
        }
      }
    })
    ```

    Transform to response format with role, memberCount from _count.
  </action>
  <verify>curl -X GET localhost:3000/api/groups with auth cookie returns JSON (empty array for new user)</verify>
  <done>GET /api/groups returns authenticated user's groups with roles.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] `npx prisma generate` succeeds
- [ ] `npm run build` succeeds
- [ ] GET /api/groups returns 401 without auth
- [ ] GET /api/groups returns groups array with auth
</verification>

<success_criteria>

- Group and Membership models in schema
- Proper foreign key relationships
- API endpoint lists user's groups
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-family-groups/03-01-SUMMARY.md`
</output>
