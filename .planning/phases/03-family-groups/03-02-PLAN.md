---
phase: 03-family-groups
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [src/app/api/groups/route.ts, src/app/api/groups/join/route.ts, src/lib/utils.ts]
---

<objective>
Create API endpoints for group creation and joining via invite code.

Purpose: Enable users to create groups and invite family members.
Output: POST /api/groups creates group, POST /api/groups/join joins via code.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./03-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-family-groups/03-01-SUMMARY.md
@prisma/schema.prisma
@src/lib/db.ts
@src/auth.ts

**Tech stack available:**
- Group and Membership models from 03-01
- Auth.js v5 session with user.id
- Prisma client

**Constraining decisions:**
- 03-01: Group has inviteCode field (unique, 8-char)
- 03-01: Membership has role field ("owner" or "member")
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create group API endpoint with owner assignment</name>
  <files>src/app/api/groups/route.ts, src/lib/utils.ts</files>
  <action>
    Create src/lib/utils.ts with invite code generator:
    ```typescript
    export function generateInviteCode(): string {
      // Generate 8-char alphanumeric code (uppercase letters + digits)
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'  // Exclude confusing chars: 0OI1
      let code = ''
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length))
      }
      return code
    }
    ```

    Add POST handler to src/app/api/groups/route.ts:

    1. Get current user from auth session
    2. If not authenticated: return 401
    3. Parse body: { name: string }
    4. Validate name: required, 1-50 chars
    5. Generate unique invite code (retry if collision)
    6. Create group and membership in transaction:
       ```typescript
       const result = await prisma.$transaction(async (tx) => {
         const group = await tx.group.create({
           data: {
             name: body.name.trim(),
             inviteCode: generateInviteCode(),
           }
         })
         await tx.membership.create({
           data: {
             userId: session.user.id,
             groupId: group.id,
             role: 'owner'
           }
         })
         return group
       })
       ```
    7. Return 201 with group data including inviteCode

    Response format:
    ```json
    {
      "id": "clx...",
      "name": "Smith Family",
      "inviteCode": "ABC12DEF",
      "createdAt": "2026-01-13T..."
    }
    ```

    Error responses:
    - 400: Invalid name (missing, too long)
    - 401: Not authenticated
    - 500: Database error
  </action>
  <verify>POST /api/groups with { "name": "Test Family" } creates group with owner membership</verify>
  <done>POST /api/groups creates group and assigns creator as owner. Returns invite code.</done>
</task>

<task type="auto">
  <name>Task 2: Create join group API endpoint via invite code</name>
  <files>src/app/api/groups/join/route.ts</files>
  <action>
    Create POST /api/groups/join endpoint:

    1. Get current user from auth session
    2. If not authenticated: return 401
    3. Parse body: { inviteCode: string }
    4. Validate inviteCode: required, 8 chars, uppercase alphanumeric
    5. Find group by inviteCode (case-insensitive: convert to uppercase)
    6. If group not found: return 404 "Invalid invite code"
    7. Check if user already a member:
       ```typescript
       const existing = await prisma.membership.findUnique({
         where: {
           userId_groupId: {
             userId: session.user.id,
             groupId: group.id
           }
         }
       })
       ```
    8. If already member: return 409 "Already a member of this group"
    9. Create membership with role "member"
    10. Return 201 with group data

    Response format:
    ```json
    {
      "id": "clx...",
      "name": "Smith Family",
      "role": "member",
      "memberCount": 3
    }
    ```

    Error responses:
    - 400: Invalid invite code format
    - 401: Not authenticated
    - 404: Group not found (invalid code)
    - 409: Already a member
  </action>
  <verify>POST /api/groups/join with valid code joins user to group, returns 409 on second attempt</verify>
  <done>POST /api/groups/join allows users to join groups via invite code.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] POST /api/groups creates group with owner role
- [ ] POST /api/groups returns invite code
- [ ] POST /api/groups/join joins user to group
- [ ] POST /api/groups/join returns 409 for duplicate membership
- [ ] POST /api/groups/join returns 404 for invalid code
</verification>

<success_criteria>

- Create group endpoint works with owner assignment
- Join group via invite code works
- Duplicate membership prevented
- Invalid codes handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-family-groups/03-02-SUMMARY.md`
</output>
