---
phase: 02-authentication
plan: 03
type: execute
depends_on: ["02-02"]
files_modified: [src/middleware.ts, src/app/page.tsx, src/components/AuthStatus.tsx, src/app/layout.tsx]
---

<objective>
Add protected routes middleware and session handling for authenticated UI.

Purpose: Secure routes and provide auth state throughout the app.
Output: Protected routes redirect to login, UI shows auth status and logout.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./02-03-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@.planning/phases/02-authentication/02-02-SUMMARY.md
@src/auth.ts
@src/app/(auth)/login/page.tsx

**Tech stack available:**
- Auth.js v5 with JWT sessions
- Working login/register flows
- Prisma User model

**Constraining decisions:**
- 02-01: JWT session strategy
- 02-02: Login at /login, register at /register
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware for protected routes</name>
  <files>src/middleware.ts</files>
  <action>
    Create src/middleware.ts using Auth.js middleware:

    ```typescript
    export { auth as middleware } from "@/auth"

    export const config = {
      matcher: [
        // Protect all routes except auth pages, api/auth, and static files
        "/((?!api/auth|_next/static|_next/image|favicon.ico|login|register).*)",
      ],
    }
    ```

    This middleware:
    - Runs on all routes except auth-related paths
    - Redirects unauthenticated users to /login
    - Uses Auth.js's built-in auth() middleware export

    Update src/auth.ts to export auth middleware:
    - Add `export const { auth, signIn, signOut } = NextAuth(authConfig)` pattern
    - Ensure auth can be used as middleware

    Note: Auth.js v5 uses a specific pattern for middleware. Check Auth.js v5 docs if the above doesn't work.
    The key is exporting auth from the NextAuth config and using it as middleware.
  </action>
  <verify>Visit / while logged out - redirects to /login. Visit / while logged in - shows page.</verify>
  <done>Protected routes redirect unauthenticated users to login. Auth pages accessible without login.</done>
</task>

<task type="auto">
  <name>Task 2: Add session handling and auth status UI</name>
  <files>src/components/AuthStatus.tsx, src/app/page.tsx, src/app/layout.tsx</files>
  <action>
    Create src/components/AuthStatus.tsx:
    - Client component ("use client")
    - Shows user email/name when logged in
    - Shows "Sign out" button that calls signOut()
    - Import useSession from "next-auth/react"

    Update src/app/layout.tsx:
    - Wrap children with SessionProvider from "next-auth/react"
    - This enables useSession hook throughout the app

    Update src/app/page.tsx:
    - Show AuthStatus component
    - Display welcome message with user's name
    - This is now a protected route (middleware handles redirect)

    The home page should:
    - Show "Welcome, {name}" or "Welcome" if no name
    - Show user's email
    - Have sign out button
    - Be mobile-first styled with Tailwind

    Keep it simple - this is placeholder content. Future phases will add real features.
  </action>
  <verify>Log in, visit /, see welcome message with name/email and working sign out button</verify>
  <done>Home page shows auth status, sign out works, session available via useSession.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Unauthenticated users redirected to /login from protected routes
- [ ] /login and /register accessible without auth
- [ ] Logged in users see auth status on home page
- [ ] Sign out clears session and redirects to login
- [ ] No TypeScript errors
</verification>

<success_criteria>

- Protected route middleware working
- Session provider enables useSession throughout app
- Auth status component shows current user
- Sign out functionality works
- Phase 2 complete - users can register, login, access protected routes
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`
</output>
