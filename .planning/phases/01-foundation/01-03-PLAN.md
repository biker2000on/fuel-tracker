---
phase: 01-foundation
plan: 03
type: execute
depends_on: ["01-02"]
files_modified: [Dockerfile, docker-compose.yml, .dockerignore]
---

<objective>
Create Docker configuration for self-hosted deployment with PostgreSQL.

Purpose: Enable one-command deployment of the full stack (app + database).
Output: Working docker-compose setup that builds and runs the app with PostgreSQL.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./01-03-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production Dockerfile</name>
  <files>Dockerfile, .dockerignore</files>
  <action>
    Create multi-stage Dockerfile for Next.js production build:

    ```dockerfile
    # Dependencies stage
    FROM node:20-alpine AS deps
    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --only=production

    # Builder stage
    FROM node:20-alpine AS builder
    WORKDIR /app
    COPY package*.json ./
    RUN npm ci
    COPY . .
    RUN npx prisma generate
    RUN npm run build

    # Runner stage
    FROM node:20-alpine AS runner
    WORKDIR /app
    ENV NODE_ENV=production

    RUN addgroup --system --gid 1001 nodejs
    RUN adduser --system --uid 1001 nextjs

    COPY --from=builder /app/public ./public
    COPY --from=builder /app/.next/standalone ./
    COPY --from=builder /app/.next/static ./.next/static
    COPY --from=builder /app/prisma ./prisma

    USER nextjs
    EXPOSE 3000
    ENV PORT=3000
    CMD ["node", "server.js"]
    ```

    Create .dockerignore to exclude unnecessary files:
    ```
    node_modules
    .next
    .git
    .env
    *.md
    .planning
    ```

    Update next.config.ts to enable standalone output:
    ```typescript
    output: 'standalone'
    ```
  </action>
  <verify>Dockerfile syntax is valid (docker build --check . or manual inspection)</verify>
  <done>Dockerfile created with multi-stage build. .dockerignore excludes dev files. next.config.ts has standalone output.</done>
</task>

<task type="auto">
  <name>Task 2: Create docker-compose for full stack</name>
  <files>docker-compose.yml</files>
  <action>
    Create docker-compose.yml with app and PostgreSQL services:

    ```yaml
    version: '3.8'

    services:
      db:
        image: postgres:16-alpine
        restart: unless-stopped
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fuel_tracker
        volumes:
          - postgres_data:/var/lib/postgresql/data
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U postgres"]
          interval: 5s
          timeout: 5s
          retries: 5

      app:
        build: .
        restart: unless-stopped
        ports:
          - "3000:3000"
        environment:
          DATABASE_URL: postgresql://postgres:postgres@db:5432/fuel_tracker?schema=public
        depends_on:
          db:
            condition: service_healthy

    volumes:
      postgres_data:
    ```

    Key points:
    - PostgreSQL 16 Alpine for small image size
    - Health check ensures DB is ready before app starts
    - Named volume for data persistence
    - App connects to db service by hostname
  </action>
  <verify>docker-compose config validates successfully (docker-compose config)</verify>
  <done>docker-compose.yml created with app and db services. Config validates.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `docker-compose config` validates without errors
- [ ] Dockerfile has valid syntax
- [ ] .dockerignore excludes node_modules, .env, .git
- [ ] next.config.ts has `output: 'standalone'`
- [ ] `npm run build` still succeeds with standalone output
</verification>

<success_criteria>

- Multi-stage Dockerfile for production builds
- docker-compose.yml with app + PostgreSQL
- Health checks ensure proper startup order
- Standalone output enabled in Next.js config
- All files committed and ready for deployment
- Phase 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
