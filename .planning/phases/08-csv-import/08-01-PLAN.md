---
phase: 08-csv-import
plan: 01
type: execute
depends_on: []
files_modified: [src/app/api/import/route.ts, src/lib/csvParser.ts]
---

<objective>
Create CSV import API endpoint for bulk fillup record import.

Purpose: Enable users to migrate historical fillup records from external sources (converted from handwritten logs).
Output: POST /api/import endpoint that accepts CSV data, validates, and creates fillup records.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/app/api/fillups/route.ts

**Tech stack available:** Next.js 16, Prisma 7, React 19
**Established patterns:** API routes with auth check, prisma queries, JSON responses

**CSV Format (expected from user's AI-converted records):**
```
date,gallons,pricePerGallon,odometer,isFull,notes,city,state
2024-01-15,12.5,3.29,45000,true,Shell station,Seattle,WA
2024-01-22,11.8,3.35,45320,true,,Bellevue,WA
```

Required columns: date, gallons, pricePerGallon, odometer, vehicleId
Optional columns: isFull (default true), notes, city, state, country, latitude, longitude
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV parser utility</name>
  <files>src/lib/csvParser.ts</files>
  <action>
    Create a CSV parsing utility that:
    1. Parse CSV string to array of objects (handle quoted fields, commas in values)
    2. Use simple string splitting - don't install external CSV library
    3. Export function: parseCSV(csvString: string): Record<string, string>[]
    4. Handle both \r\n and \n line endings
    5. First row is headers, subsequent rows are data
    6. Return empty array for empty input
    7. Handle edge cases: trailing newlines, empty rows

    AVOID: External CSV libraries - this is simple enough to handle inline.
  </action>
  <verify>Create test file and run: npx tsx test-csv.ts (manual verification)</verify>
  <done>parseCSV function exports, handles standard CSV format with quoted fields</done>
</task>

<task type="auto">
  <name>Task 2: Create import API endpoint with validation</name>
  <files>src/app/api/import/route.ts</files>
  <action>
    Create POST /api/import endpoint:

    1. Auth check (same pattern as /api/fillups)
    2. Accept JSON body with: { vehicleId: string, csv: string }
    3. Verify user has access to the specified vehicle (membership check)

    4. Parse CSV using parseCSV utility

    5. Validate each row:
       - Required: date (ISO format), gallons (positive number), pricePerGallon (positive number), odometer (positive integer)
       - Optional: isFull (boolean, default true), notes (string), city, state, country, latitude, longitude
       - Track validation errors with row numbers

    6. If validation errors exist, return 400 with errors array:
       { success: false, errors: [{ row: 2, field: "gallons", message: "must be positive" }] }

    7. If validation passes, create fillups in a transaction:
       - Calculate totalCost for each (gallons * pricePerGallon)
       - Set userId to current user
       - Set vehicleId from request
       - Sort by odometer ascending before insert (for proper MPG calculation)
       - For each fillup in order, calculate MPG from previous full fillup
       - Use prisma.$transaction for atomicity

    8. Return success response:
       { success: true, imported: count, skipped: 0 }

    AVOID: Processing more than 1000 rows (return error). Don't stream - keep it simple.
  </action>
  <verify>curl -X POST /api/import with test CSV data returns 201 with success response</verify>
  <done>Import endpoint validates CSV, creates fillups with proper MPG calculations, handles errors gracefully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] POST /api/import returns 400 for invalid CSV
- [ ] POST /api/import returns 400 for unauthorized vehicle
- [ ] POST /api/import creates fillups correctly with calculated MPG
- [ ] Transaction rolls back on partial failure
</verification>

<success_criteria>
- CSV parser handles standard CSV format
- Import endpoint validates all fields
- Fillups created with correct MPG calculations
- Errors return meaningful messages with row numbers
- Transaction ensures atomicity
</success_criteria>

<output>
After completion, create `.planning/phases/08-csv-import/08-01-SUMMARY.md`
</output>
