---
phase: 07-pwa-polish
plan: 02
type: execute
depends_on: ["07-01"]
files_modified: [src/app/sw.ts, src/hooks/useOfflineQueue.ts, src/app/api/fillups/route.ts, src/app/fillups/new/page.tsx]
---

<objective>
Implement offline capability with queued form submissions.

Purpose: Enable fillup logging even when offline at the pump - the core use case.
Output: Fillups can be entered offline and sync when connection returns.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-pwa-polish/07-01-SUMMARY.md
@src/app/sw.ts
@src/app/fillups/new/page.tsx
@src/app/api/fillups/route.ts

**Tech stack available:** Next.js 16, Serwist, React 19
**Established patterns:** Server actions avoided (using API routes), mobile-first forms
**Constraining decisions:** Self-hosted, must work offline at gas pump

**Prior decisions:**
- Fillup form uses /api/fillups POST endpoint
- Form captures: vehicleId, gallons, pricePerGallon, odometer, location, fullTank, notes, date
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create offline queue hook with IndexedDB</name>
  <files>src/hooks/useOfflineQueue.ts, src/lib/offlineDb.ts</files>
  <action>
    1. Create src/lib/offlineDb.ts for IndexedDB operations:
       - Use idb-keyval or raw IndexedDB API (idb-keyval is simpler)
       - If using raw IndexedDB: create "fuel-tracker-offline" database
       - Store: "pending-fillups" with auto-increment key
       - Methods: addToQueue(fillup), getQueue(), removeFromQueue(id), clearQueue()
    2. Create src/hooks/useOfflineQueue.ts:
       - Track online status with navigator.onLine and online/offline events
       - On form submit when offline: save to IndexedDB queue, show success toast
       - On connection restore: auto-sync queued items to /api/fillups
       - Return: { isOnline, pendingCount, queueFillup, syncQueue }
       - Handle sync errors gracefully (keep in queue if server rejects)
    3. Install idb-keyval if using it: `npm i idb-keyval`

    AVOID: Don't use localStorage (limited storage, not available in SW). Don't block UI during sync.
  </action>
  <verify>Hook can be imported without errors, TypeScript compiles</verify>
  <done>useOfflineQueue hook created with IndexedDB storage and auto-sync</done>
</task>

<task type="auto">
  <name>Task 2: Integrate offline queue into fillup form</name>
  <files>src/app/fillups/new/page.tsx</files>
  <action>
    1. Import and use useOfflineQueue hook in fillup form
    2. Modify form submission:
       - If online: submit directly to API (current behavior)
       - If offline: queue fillup locally, show "Saved offline - will sync when connected" toast
       - Show pending count badge if > 0 queued items
    3. Add visual offline indicator:
       - Show small "Offline" badge in header when disconnected
       - Show "X fillups pending sync" if queue not empty
    4. Add manual sync button (optional but helpful):
       - "Sync Now" button that appears when pending items exist and online
       - Triggers immediate sync attempt

    AVOID: Don't change the form fields or validation. Don't block form submission when offline.
  </action>
  <verify>Form submits successfully when offline (check IndexedDB), syncs when connection restored</verify>
  <done>Fillup form works offline, shows pending status, auto-syncs on reconnect</done>
</task>

<task type="auto">
  <name>Task 3: Update service worker for offline-first strategy</name>
  <files>src/app/sw.ts</files>
  <action>
    1. Update service worker caching strategy:
       - Static assets (JS, CSS, images): CacheFirst with long TTL
       - API GET requests: NetworkFirst with cache fallback for reads
       - API POST/PUT/DELETE: NetworkOnly (handled by offline queue)
       - Pages: NetworkFirst with offline fallback
    2. Add runtime caching rules for specific routes:
       - /api/vehicles: Cache for quick vehicle list access offline
       - /api/dashboard: NetworkFirst (stale data acceptable briefly)
       - /api/fillups POST: Don't cache (handled by offline queue)
    3. Ensure precache includes:
       - All static pages
       - Critical CSS/JS bundles
       - App icons
       - Offline fallback page

    AVOID: Don't cache authenticated API responses with sensitive data. Don't cache POST responses.
  </action>
  <verify>npm run build succeeds, SW includes caching rules</verify>
  <done>Service worker configured with appropriate caching strategies per route type</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Fillup form works in airplane mode (saves to IndexedDB)
- [ ] Queued fillups sync automatically when connection restored
- [ ] Offline indicator shows when disconnected
- [ ] Pending count displays correctly
</verification>

<success_criteria>
- Fillups can be logged when offline (queued locally)
- Automatic sync when connection returns
- User sees clear feedback about offline status and pending syncs
- No data loss when offline
- Service worker caches appropriately by route type
</success_criteria>

<output>
After completion, create `.planning/phases/07-pwa-polish/07-02-SUMMARY.md`
</output>
