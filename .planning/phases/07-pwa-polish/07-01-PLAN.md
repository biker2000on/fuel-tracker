---
phase: 07-pwa-polish
plan: 01
type: execute
depends_on: []
files_modified: [next.config.ts, tsconfig.json, src/app/manifest.ts, src/app/sw.ts, public/icons/*, .gitignore]
---

<objective>
Set up PWA manifest and service worker foundation using Serwist.

Purpose: Make the app installable on mobile devices with proper icons and metadata.
Output: Working PWA manifest, service worker registered, app installable on mobile.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/layout.tsx
@next.config.ts
@tsconfig.json

**Tech stack available:** Next.js 16, React 19, Tailwind 4, Prisma 7
**Established patterns:** App Router, dark mode UI, mobile-first design
**Constraining decisions:** Self-hosted Docker, mobile-first PWA

**Discovery findings (Level 1):**
- Use @serwist/next (successor to deprecated next-pwa)
- Next.js has native manifest.ts support (no library needed for manifest)
- Serwist handles precaching and runtime caching
- Service worker goes in src/app/sw.ts, compiles to public/sw.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Serwist and configure Next.js</name>
  <files>package.json, next.config.ts, tsconfig.json, .gitignore</files>
  <action>
    1. Install packages: `npm i @serwist/next && npm i -D serwist`
    2. Update next.config.ts to wrap with withSerwist:
       - Import withSerwistInit from "@serwist/next"
       - Configure swSrc: "src/app/sw.ts", swDest: "public/sw.js"
       - Set disable: process.env.NODE_ENV === "development" (SW causes issues in dev)
       - Add additionalPrecacheEntries for offline page
    3. Update tsconfig.json:
       - Add "webworker" to lib array
       - Add "@serwist/next/typings" to types array (create types array if needed)
       - Add "public/sw.js" to exclude array
    4. Update .gitignore to exclude generated SW files:
       - Add: public/sw.js, public/sw.js.map, public/swe-worker-*.js

    AVOID: Don't use deprecated next-pwa package. Don't enable SW in development mode.
  </action>
  <verify>npm run build succeeds without SW errors, tsconfig valid</verify>
  <done>Serwist configured in next.config.ts, tsconfig updated, .gitignore updated</done>
</task>

<task type="auto">
  <name>Task 2: Create PWA manifest with app icons</name>
  <files>src/app/manifest.ts, public/icons/icon-192.png, public/icons/icon-512.png, public/icons/apple-touch-icon.png</files>
  <action>
    1. Create src/app/manifest.ts (Next.js native manifest support):
       - name: "Fuel Tracker"
       - short_name: "Fuel"
       - description: "Track fuel consumption across your vehicles"
       - start_url: "/dashboard"
       - display: "standalone"
       - background_color: "#0f172a" (dark slate to match app theme)
       - theme_color: "#0f172a"
       - icons: 192x192 and 512x512 PNG icons, plus maskable version
    2. Create public/icons/ directory with placeholder icons:
       - Generate simple fuel pump icon SVGs and convert to PNG (use sharp or manual)
       - Or create colored squares as placeholders (192x192 and 512x512)
       - Create apple-touch-icon.png (180x180) for iOS
    3. Update src/app/layout.tsx metadata:
       - Add appleWebApp metadata for iOS
       - Add viewport with "viewport-fit=cover" for notch handling
       - Link to apple-touch-icon

    AVOID: Don't use external URLs for icons. Don't forget maskable icon for Android.
  </action>
  <verify>npm run build succeeds, /manifest.webmanifest returns valid JSON with icons</verify>
  <done>Manifest serves at /manifest.webmanifest, icons exist in public/icons/</done>
</task>

<task type="auto">
  <name>Task 3: Create service worker with basic caching</name>
  <files>src/app/sw.ts, src/app/~offline/page.tsx</files>
  <action>
    1. Create src/app/sw.ts service worker:
       - Import from "serwist" and "@serwist/next/worker"
       - Use defaultCache for runtime caching (Serwist's sensible defaults)
       - Configure precacheEntries from Serwist's manifest injection
       - Add fallback to /~offline for navigation failures
       - Call serwist.addEventListeners() to register handlers
    2. Create src/app/~offline/page.tsx offline fallback page:
       - Simple static page (no data fetching)
       - Message: "You're offline" with icon
       - Suggest: "Please check your connection and try again"
       - Match app's dark theme styling
       - Use only Tailwind classes (no external resources)

    AVOID: Don't cache API routes (they need fresh data). Don't cache POST requests.
  </action>
  <verify>npm run build succeeds, public/sw.js is generated (check file exists after build)</verify>
  <done>Service worker compiles to public/sw.js, offline page exists at /~offline</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] public/sw.js is generated after build
- [ ] /manifest.webmanifest returns valid JSON
- [ ] Icons exist at specified paths (192, 512, apple-touch)
- [ ] /~offline page renders correctly
</verification>

<success_criteria>
- Serwist properly configured and generating service worker
- PWA manifest complete with all required fields
- App icons in place (can be placeholders, but correct sizes)
- Offline fallback page styled to match app
- Build succeeds with no warnings
</success_criteria>

<output>
After completion, create `.planning/phases/07-pwa-polish/07-01-SUMMARY.md`
</output>
