---
phase: 05-fillup-entry
plan: 02
type: execute
depends_on: ["05-01"]
files_modified: [src/hooks/useGeolocation.ts, src/lib/geocoding.ts]
---

<objective>
Add location auto-detection using Browser Geolocation API and reverse geocoding with Nominatim.

Purpose: Enable automatic location capture when logging fillups at the pump.
Output: Reusable geolocation hook and geocoding utility for fillup forms.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./05-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-fillup-entry/05-01-SUMMARY.md

**Location strategy (no external API keys needed):**
- Browser Geolocation API: navigator.geolocation.getCurrentPosition()
- Nominatim (OpenStreetMap): Free reverse geocoding, no API key required
- Rate limit compliance: Include User-Agent header, max 1 request/second

**Design decisions:**
- Location is optional - app works without it
- Graceful degradation: if geolocation fails, user can skip or enter manually
- Cache location briefly (5 min) to avoid repeated prompts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create geolocation hook</name>
  <files>src/hooks/useGeolocation.ts</files>
  <action>
Create useGeolocation hook that wraps the Browser Geolocation API:

```typescript
interface GeolocationState {
  latitude: number | null
  longitude: number | null
  accuracy: number | null  // meters
  loading: boolean
  error: string | null
  timestamp: number | null
}

interface UseGeolocationOptions {
  enableHighAccuracy?: boolean  // default true for pump precision
  timeout?: number  // default 10000ms
  maximumAge?: number  // default 300000ms (5 min cache)
}

function useGeolocation(options?: UseGeolocationOptions): GeolocationState & {
  refresh: () => void  // Force re-fetch location
  isSupported: boolean  // Browser supports geolocation
}
```

Implementation:
- Check navigator.geolocation exists (isSupported)
- On mount, attempt to get position with options
- Handle PermissionDenied, PositionUnavailable, Timeout errors with user-friendly messages
- Return loading state while fetching
- Provide refresh() to manually re-request position
- Don't auto-request on mount - require explicit call or trigger

Error messages:
- PermissionDenied: "Location permission denied. Enable in browser settings."
- PositionUnavailable: "Unable to determine location."
- Timeout: "Location request timed out. Try again."
  </action>
  <verify>Hook compiles without errors, can be imported and used in a component</verify>
  <done>useGeolocation hook returns coordinates, handles errors gracefully, provides refresh function</done>
</task>

<task type="auto">
  <name>Task 2: Create geocoding utility</name>
  <files>src/lib/geocoding.ts</files>
  <action>
Create geocoding utility using Nominatim (OpenStreetMap) for reverse geocoding:

```typescript
interface GeocodedLocation {
  city: string | null
  state: string | null
  country: string | null
}

async function reverseGeocode(
  latitude: number,
  longitude: number
): Promise<GeocodedLocation>
```

Implementation:
- Use Nominatim reverse endpoint: https://nominatim.openstreetmap.org/reverse
- Required params: lat, lon, format=json
- Include User-Agent header with app name (required by Nominatim TOS)
- Parse response to extract city (from city/town/village), state (from state), country
- Return null fields if not found (don't throw)
- Handle network errors gracefully (return all nulls)
- Add 1 second delay between calls if needed (rate limit compliance)

Example Nominatim response parsing:
- city: address.city || address.town || address.village || address.municipality
- state: address.state
- country: address.country

Export both the function and a helper to format location string:
```typescript
function formatLocation(loc: GeocodedLocation): string | null
// Returns "City, State" or "City, Country" or null
```
  </action>
  <verify>Function compiles, can call reverseGeocode(lat, lng) and get location object back</verify>
  <done>reverseGeocode returns city/state/country from coordinates, handles errors gracefully, complies with Nominatim TOS</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] useGeolocation hook can be imported and called
- [ ] reverseGeocode function returns location data for valid coordinates
- [ ] Nominatim User-Agent header is included in requests
- [ ] Error states handled gracefully (no crashes on permission denied)
</verification>

<success_criteria>

- Geolocation hook works with proper error handling
- Geocoding utility returns city/state/country
- Nominatim TOS compliance (User-Agent, rate limiting)
- No external API keys required
</success_criteria>

<output>
After completion, create `.planning/phases/05-fillup-entry/05-02-SUMMARY.md`
</output>
