---
phase: 05-fillup-entry
plan: 01
type: execute
depends_on: []
files_modified: [prisma/schema.prisma, src/app/api/fillups/route.ts, src/app/api/fillups/[id]/route.ts]
---

<objective>
Add Fillup model and CRUD API routes for logging fuel fillups.

Purpose: Establish the data model and API foundation for fillup tracking that future plans depend on.
Output: Prisma Fillup model and working API endpoints for creating, reading, updating, and deleting fillups.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./05-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/app/api/vehicles/route.ts
@src/lib/db.ts

**Established patterns:**
- API routes use `auth()` from `@/auth` for session
- Prisma client imported from `@/lib/db`
- NextResponse.json for all responses
- Input validation with specific error messages
- Membership verification before vehicle operations

**From PROJECT.md requirements:**
- Fillup entry: date, gallons, price, odometer, car's MPG estimate, full/partial, notes
- Auto-detect location (city, state, country) and GPS coordinates (handled in Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Fillup model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add Fillup model with fields:
- id: String @id @default(cuid())
- date: DateTime (when fillup occurred)
- gallons: Float (amount of fuel)
- pricePerGallon: Float (price per gallon)
- totalCost: Float (computed: gallons * pricePerGallon, stored for convenience)
- odometer: Int (current odometer reading)
- mpg: Float? (calculated MPG since last fillup, null for first fillup)
- isFull: Boolean @default(true) (full tank or partial)
- notes: String? (optional user notes)
- latitude: Float? (GPS latitude, optional)
- longitude: Float? (GPS longitude, optional)
- city: String? (reverse geocoded city)
- state: String? (reverse geocoded state/region)
- country: String? (reverse geocoded country)
- vehicleId: String (FK to Vehicle)
- userId: String (FK to User who logged it)
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt

Add relations:
- Vehicle: fillups Fillup[]
- User: fillups Fillup[]

Add indexes on vehicleId, userId, date for query performance.

Run `npx prisma generate` to regenerate client.
  </action>
  <verify>npx prisma validate passes, npx prisma generate succeeds, schema includes Fillup model with vehicle and user relations</verify>
  <done>Fillup model exists in schema with all fields, relations to Vehicle and User established, Prisma client regenerated</done>
</task>

<task type="auto">
  <name>Task 2: Create fillup API routes</name>
  <files>src/app/api/fillups/route.ts, src/app/api/fillups/[id]/route.ts</files>
  <action>
Create /api/fillups/route.ts:
- GET: List fillups for user's vehicles. Accept optional query params: vehicleId (filter by vehicle), limit (default 50). Query user's group memberships, get vehicles, then fillups. Return array with fillup data + vehicleName.
- POST: Create fillup. Require { vehicleId, date, gallons, pricePerGallon, odometer, isFull? }. Optional: { notes, latitude, longitude, city, state, country }. Verify user is member of vehicle's group before creating. Calculate totalCost (gallons * pricePerGallon). Calculate mpg if previous fillup exists and both are full tanks: (current_odometer - previous_odometer) / previous_gallons. Return created fillup.

Create /api/fillups/[id]/route.ts:
- GET: Get single fillup by id. Verify user is member of vehicle's group before returning.
- PATCH: Update fillup fields. Verify membership. Accept partial updates. Recalculate totalCost if gallons or pricePerGallon changes.
- DELETE: Delete fillup. Verify user is member of vehicle's group.

Validation rules:
- vehicleId: required, must be vehicle in user's group
- date: required, valid ISO date string
- gallons: required, positive number
- pricePerGallon: required, positive number
- odometer: required, positive integer
- isFull: optional, boolean (default true)
- notes: optional, string max 500 chars
- latitude: optional, number -90 to 90
- longitude: optional, number -180 to 180
- city, state, country: optional strings

Error responses:
- 401: Not authenticated
- 403: Not a member of the vehicle's group
- 404: Fillup or vehicle not found
- 400: Validation errors with specific message
  </action>
  <verify>
curl -X GET /api/fillups returns fillups array (or empty)
curl -X POST /api/fillups with valid body creates fillup and returns 201
curl -X GET /api/fillups/[id] returns fillup
curl -X PATCH /api/fillups/[id] updates and returns fillup
curl -X DELETE /api/fillups/[id] returns 204
  </verify>
  <done>All CRUD operations work, membership validation enforced, MPG calculation works for full tank fillups, proper error responses</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] `npm run build` succeeds without errors
- [ ] GET /api/fillups returns user's fillups
- [ ] POST /api/fillups creates fillup with calculated totalCost
- [ ] POST /api/fillups returns 403 for non-member vehicle
- [ ] GET/PATCH/DELETE /api/fillups/[id] work with membership checks
- [ ] MPG calculation works correctly for consecutive full fillups
</verification>

<success_criteria>

- Fillup model in Prisma schema with vehicle and user relations
- All CRUD API endpoints functional
- Group membership validation on all operations
- MPG auto-calculation for full tank fillups
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-fillup-entry/05-01-SUMMARY.md`
</output>
