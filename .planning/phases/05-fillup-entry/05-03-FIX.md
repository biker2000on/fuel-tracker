---
phase: 05-fillup-entry
plan: 05-03-FIX
type: fix
depends_on: []
files_modified: [src/app/fillups/[id]/edit/page.tsx, src/lib/geocoding.ts]
---

<objective>
Fix 2 UAT issues from plan 05-03.

Source: 05-03-ISSUES.md
Priority: 0 critical, 1 major, 1 minor
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/05-fillup-entry/05-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/05-fillup-entry/05-03-PLAN.md

**Existing code to reference:**
@src/app/fillups/new/page.tsx
@src/app/api/fillups/[id]/route.ts
@src/lib/geocoding.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Create fillup edit page</name>
  <files>src/app/fillups/[id]/edit/page.tsx</files>
  <action>
    Create edit page at /fillups/[id]/edit that:

    1. Fetches fillup data via GET /api/fillups/[id] on mount
    2. Pre-populates form with existing values (gallons, pricePerGallon, odometer, date, isFull, notes, location)
    3. Uses same form layout as /fillups/new/page.tsx but without vehicle selection (vehicle is fixed)
    4. Shows vehicle name at top (read-only)
    5. Submits via PATCH /api/fillups/[id]
    6. On success, redirects to /vehicles/[vehicleId]/fillups with success message

    Base the form on the existing new fillup form but:
    - Remove vehicle selection (show vehicle name as read-only header)
    - Pre-populate all fields from fetched data
    - Change submit to PATCH instead of POST
    - Keep the live total cost calculation
    - Allow editing location (keep existing or detect new)

    Wrap in Suspense boundary for useParams compatibility.
  </action>
  <verify>
    - Navigate to /fillups/[id]/edit
    - Form loads with pre-populated data
    - Edit a field (e.g., gallons) and submit
    - Redirects to fillup history with updated data
  </verify>
  <done>Edit page exists, loads fillup data, saves changes via PATCH, redirects on success</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-002 - Improve geocoding city detection</name>
  <files>src/lib/geocoding.ts</files>
  <action>
    Update reverseGeocode function to check additional Nominatim address fields for city:

    Nominatim returns city under various keys depending on location type:
    - city (large cities)
    - town (smaller towns)
    - village (villages)
    - municipality (some regions)
    - county (US counties - often useful as fallback)
    - suburb (neighborhoods in cities)
    - hamlet (very small settlements)

    Update the city extraction to check more fields:
    ```typescript
    city: address.city || address.town || address.village || address.municipality || address.county || address.suburb || address.hamlet || null
    ```

    Also add `addressdetails=1` to the Nominatim URL to ensure full address details are returned.
  </action>
  <verify>
    - Test geocoding with a location that previously returned no city
    - City field should now be populated with county or other fallback
  </verify>
  <done>Geocoding returns city more reliably using additional address fields</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-001: /fillups/[id]/edit loads with fillup data
- [ ] UAT-001: Edit and save works correctly
- [ ] UAT-002: Geocoding returns city more often (county fallback)
- [ ] `npm run build` succeeds
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All UAT issues from 05-03-ISSUES.md addressed
- Edit page functional
- Geocoding improved
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/05-fillup-entry/05-03-FIX-SUMMARY.md`

Also update 05-03-ISSUES.md to move fixed issues to "Resolved Issues" section.
</output>
