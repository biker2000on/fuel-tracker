---
phase: 06-history-analytics
plan: 02
type: execute
depends_on: []
files_modified: [src/app/api/vehicles/[id]/stats/route.ts, src/app/vehicles/[id]/page.tsx]
---

<objective>
Add comprehensive fuel economy statistics and calculations per vehicle.

Purpose: Users want to see meaningful MPG trends, cost analysis, and driving patterns - the fillup data should tell a story.
Output: Stats API endpoint and enhanced vehicle detail page with statistics section.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/app/vehicles/[id]/page.tsx
@src/app/api/fillups/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vehicle stats API endpoint</name>
  <files>src/app/api/vehicles/[id]/stats/route.ts</files>
  <action>
    Create GET /api/vehicles/[id]/stats that returns computed statistics:

    ```typescript
    {
      overview: {
        totalFillups: number
        totalGallons: number
        totalCost: number
        totalMiles: number  // difference between first and last odometer
        firstFillup: string | null  // ISO date
        lastFillup: string | null   // ISO date
      },
      mpg: {
        average: number | null
        best: number | null
        worst: number | null
        recent: number | null  // avg of last 5 fillups with MPG
      },
      costs: {
        averagePricePerGallon: number | null
        averageCostPerFillup: number | null
        costPerMile: number | null  // totalCost / totalMiles
      },
      frequency: {
        averageDaysBetweenFillups: number | null
        averageMilesBetweenFillups: number | null
      }
    }
    ```

    Query all fillups for the vehicle, compute stats in-memory. Verify user has access via group membership (same pattern as other vehicle endpoints).

    Handle edge cases:
    - 0 fillups: return nulls for computed values
    - 1 fillup: no MPG/frequency data
    - Partial fillups (isFull=false): exclude from MPG calculations
  </action>
  <verify>
    curl /api/vehicles/{id}/stats returns computed statistics
    - Vehicle with 0 fillups returns valid response with null values
    - Vehicle with fillups shows correct calculations
  </verify>
  <done>Stats endpoint returns comprehensive vehicle statistics, handles edge cases</done>
</task>

<task type="auto">
  <name>Task 2: Add statistics section to vehicle detail page</name>
  <files>src/app/vehicles/[id]/page.tsx</files>
  <action>
    Add a "Statistics" section to the vehicle detail page that displays stats from the API:

    Layout (mobile-first grid):
    - Fuel Economy card: avg/best/worst/recent MPG with color coding (green for good, red for poor)
    - Costs card: avg price/gallon, cost/mile, total spent
    - Activity card: total fillups, total miles, avg days between fillups

    Fetch stats on page load alongside vehicle data (parallel fetch). Show loading skeleton for stats section.

    If no fillups, show "No fillup data yet - log your first fillup to see statistics"

    Use existing Tailwind patterns from fillups page (cards, text styles).
  </action>
  <verify>
    - Visit /vehicles/{id} shows statistics section
    - Stats load and display correctly
    - Vehicle with no fillups shows helpful message
    - Mobile layout works (stacked cards)
  </verify>
  <done>Vehicle detail page shows comprehensive statistics section with proper loading states</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Stats API returns correct calculations
- [ ] Vehicle page displays statistics
- [ ] Edge cases handled (0 fillups, 1 fillup)
- [ ] No TypeScript errors
</verification>

<success_criteria>

- Stats API endpoint created with comprehensive metrics
- Vehicle detail page shows statistics section
- Calculations are correct (verified manually)
- Mobile-responsive layout
</success_criteria>

<output>
After completion, create `.planning/phases/06-history-analytics/06-02-SUMMARY.md`
</output>
