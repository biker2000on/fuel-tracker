---
phase: 13-profile-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/user/profile/route.ts
  - src/app/api/user/password/route.ts
autonomous: true

must_haves:
  truths:
    - "User can view their current profile (name, email)"
    - "User can update their display name"
    - "User can change their password with verification"
  artifacts:
    - path: "src/app/api/user/profile/route.ts"
      provides: "GET/PATCH for user profile"
      exports: ["GET", "PATCH"]
    - path: "src/app/api/user/password/route.ts"
      provides: "POST for password change"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/user/profile/route.ts"
      to: "prisma.user"
      via: "findUnique and update"
      pattern: "prisma\\.user\\.(findUnique|update)"
    - from: "src/app/api/user/password/route.ts"
      to: "bcrypt"
      via: "compare and hash"
      pattern: "bcrypt\\.(compare|hash)"
---

<objective>
Create user profile and password management API endpoints.

Purpose: Enable the profile page to read and update user data, and allow secure password changes.
Output: Two API route files providing profile CRUD and password change functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing API patterns to follow
@src/app/api/vehicles/[id]/route.ts
@src/app/api/auth/register/route.ts

# Auth and database
@src/auth.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user profile API endpoint</name>
  <files>src/app/api/user/profile/route.ts</files>
  <action>
Create GET and PATCH handlers for `/api/user/profile`:

**GET handler:**
- Get session via `auth()` from `@/auth`
- Return 401 if not authenticated
- Query `prisma.user.findUnique` by session.user.id
- Return user object with: id, email, name, createdAt
- Do NOT include passwordHash in response

**PATCH handler:**
- Get session, return 401 if not authenticated
- Parse JSON body, expect `{ name?: string }`
- Validate name: string, trim, 1-100 chars
- Update user via `prisma.user.update`
- Return updated user object (id, email, name, updatedAt)

Follow the pattern in vehicles/[id]/route.ts for auth checks and response formatting.
  </action>
  <verify>
```bash
# Build passes
npm run build

# Manual test (requires auth):
# GET /api/user/profile returns user data
# PATCH /api/user/profile with { "name": "New Name" } updates name
```
  </verify>
  <done>Profile API returns user data on GET, updates name on PATCH with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create password change API endpoint</name>
  <files>src/app/api/user/password/route.ts</files>
  <action>
Create POST handler for `/api/user/password`:

**POST handler:**
- Get session via `auth()`, return 401 if not authenticated
- Parse JSON body: `{ currentPassword: string, newPassword: string }`
- Validate both fields required
- Validate newPassword: minimum 8 characters (same as registration)
- Query user from database to get passwordHash
- Use `bcrypt.compare()` to verify currentPassword matches stored hash
- Return 400 with "Current password is incorrect" if no match
- Hash newPassword with `bcrypt.hash(newPassword, 10)` (10 salt rounds, same as registration)
- Update user passwordHash via `prisma.user.update`
- Return 200 with `{ message: "Password updated successfully" }`

Import bcrypt from 'bcrypt' (already in package.json, used by auth/register).
  </action>
  <verify>
```bash
# Build passes
npm run build

# Manual test scenarios:
# POST with wrong currentPassword returns 400
# POST with short newPassword (<8 chars) returns 400
# POST with valid data returns 200
```
  </verify>
  <done>Password change endpoint verifies current password and updates to new password securely</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- Both route files exist and export correct HTTP methods
- No TypeScript errors in the new files
</verification>

<success_criteria>
- GET /api/user/profile returns authenticated user's data
- PATCH /api/user/profile updates user name with validation
- POST /api/user/password changes password after verification
- All endpoints return 401 for unauthenticated requests
</success_criteria>

<output>
After completion, create `.planning/phases/13-profile-page/13-01-SUMMARY.md`
</output>
