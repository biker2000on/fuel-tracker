---
phase: 11-pwa-offline
plan: 03
type: execute
wave: 2
depends_on: ["11-02"]
files_modified:
  - src/lib/syncEngine.ts
  - src/lib/offlineDb.ts
  - src/hooks/useOfflineQueue.ts
  - src/contexts/OfflineContext.tsx
  - src/components/PendingFillupBadge.tsx
  - src/app/vehicles/[id]/fillups/page.tsx
autonomous: true

must_haves:
  truths:
    - "Sync automatically retries with backoff on failure"
    - "User sees toast when fillups sync successfully"
    - "Queued fillups show inline in history with pending badge"
    - "User can edit or delete queued fillups before sync"
  artifacts:
    - path: "src/lib/syncEngine.ts"
      provides: "Sync logic with retry and backoff"
      exports: ["syncPendingFillups", "SyncResult"]
    - path: "src/components/PendingFillupBadge.tsx"
      provides: "Badge component for pending fillups"
      exports: ["PendingFillupBadge"]
  key_links:
    - from: "src/hooks/useOfflineQueue.ts"
      to: "src/lib/syncEngine.ts"
      via: "sync function import"
      pattern: "import.*syncEngine"
    - from: "src/app/vehicles/[id]/fillups/page.tsx"
      to: "src/lib/offlineDb.ts"
      via: "queue data fetch"
      pattern: "getQueue|PendingFillup"
---

<objective>
Enhance sync engine with retry/backoff and display pending fillups in history

Purpose: Improve reliability of offline sync with automatic retry on failure, and give users visibility into queued fillups waiting to sync. Users should be able to manage queued items.

Output: Robust sync engine with retry logic, pending fillups visible in history with edit/delete capability
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-pwa-offline/11-CONTEXT.md
@.planning/phases/11-pwa-offline/11-RESEARCH.md

# Key existing files
@src/lib/offlineDb.ts
@src/hooks/useOfflineQueue.ts
@src/contexts/OfflineContext.tsx
@src/app/vehicles/[id]/fillups/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create syncEngine with retry and backoff</name>
  <files>src/lib/syncEngine.ts</files>
  <action>
Create syncEngine.ts with robust sync logic:

```typescript
interface SyncResult {
  success: boolean
  pendingId: string
  error?: string
  retryCount: number
}

interface SyncOptions {
  maxRetries?: number  // default: 3
  baseDelay?: number   // default: 1000ms
  maxDelay?: number    // default: 30000ms
}
```

Key functions:
1. `syncSingleFillup(pending: PendingFillup, options?: SyncOptions): Promise<SyncResult>`
   - POST to /api/fillups
   - On network error or 5xx: retry with exponential backoff (delay * 2^attempt)
   - On 4xx: don't retry (client error)
   - Return result with retryCount

2. `syncPendingFillups(options?: SyncOptions): Promise<{ results: SyncResult[], syncedCount: number }>`
   - Get queue from offlineDb
   - Sync each fillup sequentially (to maintain order)
   - Remove successful items from queue
   - Return aggregated results

Backoff formula: `min(baseDelay * 2^attempt, maxDelay)`

Export types and functions for use in useOfflineQueue hook.
  </action>
  <verify>File exports syncPendingFillups and SyncResult type</verify>
  <done>syncEngine handles retry with exponential backoff, removes synced items from queue</done>
</task>

<task type="auto">
  <name>Task 2: Update useOfflineQueue and OfflineContext to use syncEngine</name>
  <files>src/hooks/useOfflineQueue.ts, src/contexts/OfflineContext.tsx</files>
  <action>
Update useOfflineQueue.ts:
1. Import syncPendingFillups from syncEngine
2. Replace inline sync logic with syncEngine call
3. After successful sync: show toast via callback (pass onSyncComplete callback)
4. Track lastSyncTime for "Back online" toast logic
5. Export getPendingFillups function for UI to fetch queue items

Update OfflineContext.tsx:
1. Use updated useOfflineQueue hook
2. Wire pendingCount and isSyncing from useOfflineQueue
3. Add syncQueue function to context
4. Add onSyncSuccess callback that shows "X fillups synced" toast via ConnectionToast

The "X fillups synced" toast should only show when:
- User was offline (wasOffline = true)
- Came back online
- Had items to sync (syncedCount > 0)
  </action>
  <verify>Offline context provides pendingCount, isSyncing, syncQueue</verify>
  <done>useOfflineQueue uses syncEngine, OfflineContext exposes sync state</done>
</task>

<task type="auto">
  <name>Task 3: Display pending fillups in history with badge and actions</name>
  <files>src/components/PendingFillupBadge.tsx, src/app/vehicles/[id]/fillups/page.tsx, src/lib/offlineDb.ts</files>
  <action>
Create PendingFillupBadge.tsx:
- Small badge/pill showing "Pending" or clock icon
- Amber/yellow color to indicate waiting state
- Optional: show estimated MPG with "~" prefix and "(estimated)" label

Update offlineDb.ts:
- Add `updateQueueItem(id: string, data: Partial<PendingFillup['data']>)` function
- Allows editing queued fillups before sync

Update fillups/page.tsx to show pending fillups:
1. Import getQueue from offlineDb and useOffline from context
2. Fetch pending fillups for current vehicle on mount
3. Merge pending fillups with server fillups in display:
   - Pending items sorted by createdAt, shown at top with PendingFillupBadge
   - Calculate estimated MPG locally if previous odometer available
4. Pending items are expandable like regular fillups
5. Edit action: navigate to edit page (or inline edit) that updates queue
6. Delete action: remove from queue via removeFromQueue

Note: Pending fillups don't have server ID, use local queue ID for key.
Show "Pending sync" in expanded details with option to "Sync now" if online.
  </action>
  <verify>View fillups page while offline with queued items - see pending badge and edit/delete options</verify>
  <done>Pending fillups display in history with badge, editable and deletable before sync</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Go offline, log a fillup - it queues
3. View fillups page - see pending item with badge at top
4. Edit pending fillup - changes save to queue
5. Delete pending fillup - removes from queue
6. Go online - sync happens automatically with retry on failure
7. Toast shows "1 fillup synced" on successful sync
</verification>

<success_criteria>
- Sync retries automatically with exponential backoff
- Pending fillups visible in history with clear pending indicator
- Users can edit and delete pending fillups before sync
- Toast notification on successful sync
</success_criteria>

<output>
After completion, create `.planning/phases/11-pwa-offline/11-03-SUMMARY.md`
</output>
