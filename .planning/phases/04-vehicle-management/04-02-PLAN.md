---
phase: 04-vehicle-management
plan: 02
type: execute
depends_on: ["04-01"]
files_modified: [src/app/api/vehicles/[id]/photo/route.ts, src/lib/upload.ts, next.config.ts]
---

<objective>
Add photo upload capability for vehicles with local file storage.

Purpose: Enable users to visually identify vehicles with photos, stored locally for self-hosted deployment.
Output: Photo upload API endpoint and static file serving for uploaded images.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./04-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-vehicle-management/04-01-SUMMARY.md
@src/app/api/vehicles/[id]/route.ts

**Design decision: Local storage**
Since this is self-hosted Docker deployment, use local filesystem storage:
- Store photos in `public/uploads/vehicles/` directory
- Files served directly by Next.js static file serving
- No external cloud storage dependencies
- Docker volume can persist uploads across container restarts

**File handling:**
- Accept common image formats: jpg, jpeg, png, webp
- Max file size: 5MB
- Generate unique filename using cuid
- Store as `/uploads/vehicles/{vehicleId}-{cuid}.{ext}`
- Delete old photo when replacing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upload utility and photo API endpoint</name>
  <files>src/lib/upload.ts, src/app/api/vehicles/[id]/photo/route.ts</files>
  <action>
Create src/lib/upload.ts:
- saveVehiclePhoto(vehicleId: string, file: File): Promise<string> - saves file, returns URL path
- deleteVehiclePhoto(photoUrl: string): Promise<void> - deletes file if exists
- Use fs/promises for file operations
- Ensure uploads directory exists (create if not)
- Validate file type (image/jpeg, image/png, image/webp)
- Validate file size (max 5MB)
- Generate filename: `{vehicleId}-{cuid()}.{ext}`
- Return URL path: `/uploads/vehicles/{filename}`

Create /api/vehicles/[id]/photo/route.ts:
- POST: Upload photo for vehicle
  - Verify user is member of vehicle's group
  - Accept multipart/form-data with 'photo' field
  - Use request.formData() to get file
  - Validate it's an image and under size limit
  - If vehicle has existing photoUrl, delete old file
  - Save new photo, update vehicle.photoUrl in database
  - Return { photoUrl: '/uploads/vehicles/...' }
- DELETE: Remove photo from vehicle
  - Verify membership
  - Delete file if exists
  - Set vehicle.photoUrl to null
  - Return 204

Error responses:
- 400: No file provided, invalid file type, file too large
- 401: Not authenticated
- 403: Not a member of vehicle's group
- 404: Vehicle not found
  </action>
  <verify>
curl -X POST /api/vehicles/[id]/photo -F "photo=@test.jpg" returns photoUrl
File exists at public/uploads/vehicles/
curl -X DELETE /api/vehicles/[id]/photo returns 204
File is deleted
  </verify>
  <done>Photo upload works, files stored in public/uploads/vehicles/, old photos deleted on replace, DELETE removes file and clears photoUrl</done>
</task>

<task type="auto">
  <name>Task 2: Configure Next.js for upload directory and add .gitkeep</name>
  <files>next.config.ts, public/uploads/vehicles/.gitkeep, .dockerignore</files>
  <action>
Ensure public/uploads/vehicles/ directory exists with .gitkeep file (empty file to track directory in git).

Update .dockerignore (if exists) or create it to NOT ignore public/uploads so the directory structure is preserved in builds.

Verify next.config.ts doesn't need changes - Next.js serves files from public/ by default.

Note: In production Docker setup, the uploads directory should be mounted as a volume for persistence. This is a deployment concern, not code change. Document in summary.
  </action>
  <verify>
Directory public/uploads/vehicles/ exists
.gitkeep file present
Static files in public/uploads/ are accessible via browser
  </verify>
  <done>Upload directory exists, tracked in git, static serving works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] POST /api/vehicles/[id]/photo accepts image upload
- [ ] Uploaded file appears in public/uploads/vehicles/
- [ ] Vehicle.photoUrl updated in database
- [ ] DELETE /api/vehicles/[id]/photo removes file and clears photoUrl
- [ ] Replacing photo deletes old file
- [ ] Invalid file types rejected with 400
- [ ] Files over 5MB rejected with 400
</verification>

<success_criteria>

- Photo upload endpoint works
- Files stored locally in public/uploads/vehicles/
- Old photos cleaned up on replace/delete
- File validation (type, size) enforced
</success_criteria>

<output>
After completion, create `.planning/phases/04-vehicle-management/04-02-SUMMARY.md`

Note in summary: For production Docker deployment, mount /app/public/uploads as a volume for persistence.
</output>
