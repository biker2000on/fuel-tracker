---
phase: 04-vehicle-management
plan: 01
type: execute
depends_on: []
files_modified: [prisma/schema.prisma, src/app/api/vehicles/route.ts, src/app/api/vehicles/[id]/route.ts]
---

<objective>
Add Vehicle model and CRUD API routes for managing vehicles within family groups.

Purpose: Establish the data model and API foundation for vehicle management that future plans depend on.
Output: Prisma Vehicle model and working API endpoints for creating, reading, updating, and deleting vehicles.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./04-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/app/api/groups/route.ts
@src/lib/db.ts

**Established patterns:**
- API routes use `auth()` from `@/auth` for session
- Prisma client imported from `@/lib/db`
- NextResponse.json for all responses
- Input validation with specific error messages
- Transactions for multi-step operations

**From Phase 3:**
- Groups and Memberships exist
- Vehicles must belong to a group
- All group members can view/manage group's vehicles
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Vehicle model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add Vehicle model with fields:
- id: String @id @default(cuid())
- name: String (user-friendly name like "Dad's Truck")
- year: Int (4-digit year)
- make: String (e.g., "Toyota")
- model: String (e.g., "Camry")
- tankSize: Float? (gallons, optional)
- fuelType: String @default("regular") (regular, premium, diesel, e85)
- photoUrl: String? (optional, for photo upload in Plan 02)
- groupId: String (FK to Group)
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt

Add relation to Group model: vehicles Vehicle[]
Add indexes on groupId for query performance.

Run `npx prisma generate` and `npx prisma db push` to apply changes.
  </action>
  <verify>npx prisma validate passes, npx prisma generate succeeds, schema includes Vehicle model with group relation</verify>
  <done>Vehicle model exists in schema with all fields, relation to Group established, Prisma client regenerated</done>
</task>

<task type="auto">
  <name>Task 2: Create vehicle API routes</name>
  <files>src/app/api/vehicles/route.ts, src/app/api/vehicles/[id]/route.ts</files>
  <action>
Create /api/vehicles/route.ts:
- GET: List all vehicles for user's groups. Query user's memberships, get all groupIds, then get vehicles where groupId in that list. Return array with vehicle data + groupName.
- POST: Create vehicle. Require { name, year, make, model, groupId, tankSize?, fuelType? }. Validate user is member of groupId before creating. Return created vehicle.

Create /api/vehicles/[id]/route.ts:
- GET: Get single vehicle by id. Verify user is member of vehicle's group before returning.
- PATCH: Update vehicle fields. Verify membership. Accept partial updates (only fields provided).
- DELETE: Delete vehicle. Verify user is member of vehicle's group.

Validation rules:
- name: required, string, 1-50 chars
- year: required, integer, 1900-2100
- make: required, string, 1-50 chars
- model: required, string, 1-50 chars
- tankSize: optional, positive number
- fuelType: optional, one of: regular, premium, diesel, e85 (default: regular)
- groupId: required for POST, must be a group user belongs to

Error responses:
- 401: Not authenticated
- 403: Not a member of the vehicle's group
- 404: Vehicle not found
- 400: Validation errors with specific message
  </action>
  <verify>
curl -X GET /api/vehicles returns vehicles array (or empty)
curl -X POST /api/vehicles with valid body creates vehicle and returns 201
curl -X GET /api/vehicles/[id] returns vehicle
curl -X PATCH /api/vehicles/[id] updates and returns vehicle
curl -X DELETE /api/vehicles/[id] returns 204
  </verify>
  <done>All CRUD operations work, membership validation enforced, proper error responses</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] `npm run build` succeeds without errors
- [ ] GET /api/vehicles returns user's group vehicles
- [ ] POST /api/vehicles creates vehicle (when member of group)
- [ ] POST /api/vehicles returns 403 for non-member group
- [ ] GET/PATCH/DELETE /api/vehicles/[id] work with membership checks
</verification>

<success_criteria>

- Vehicle model in Prisma schema with group relation
- All CRUD API endpoints functional
- Group membership validation on all operations
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-vehicle-management/04-01-SUMMARY.md`
</output>
