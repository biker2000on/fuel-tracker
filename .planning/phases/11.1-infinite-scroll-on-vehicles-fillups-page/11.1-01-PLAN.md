---
phase: 11.1-infinite-scroll-on-vehicles-fillups-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/vehicles/[id]/fillups/page.tsx
autonomous: true

must_haves:
  truths:
    - "More fillups load automatically when user scrolls to bottom"
    - "No duplicate API calls during scroll momentum"
    - "Screen reader users hear loading announcements"
    - "Keyboard users can skip past fillup list"
    - "Offline users see limited history indicator after cached fillups"
  artifacts:
    - path: "src/app/vehicles/[id]/fillups/page.tsx"
      provides: "Infinite scroll with IntersectionObserver"
      contains: "IntersectionObserver"
  key_links:
    - from: "src/app/vehicles/[id]/fillups/page.tsx"
      to: "loadMore()"
      via: "IntersectionObserver callback"
      pattern: "entries\\[0\\]\\.isIntersecting.*loadMore"
---

<objective>
Add infinite scroll to the vehicles fillups page, replacing the "Load More" button with automatic loading when the user scrolls near the bottom.

Purpose: Improve UX for users with large fillup histories by eliminating manual pagination clicks while maintaining accessibility for keyboard and screen reader users.

Output: Updated fillups page with IntersectionObserver-based infinite scroll, ARIA live region for loading announcements, skip link for keyboard users, and offline cache limit indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11.1-infinite-scroll-on-vehicles-fillups-page/11.1-RESEARCH.md
@src/app/vehicles/[id]/fillups/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Load More button with IntersectionObserver infinite scroll</name>
  <files>src/app/vehicles/[id]/fillups/page.tsx</files>
  <action>
Replace the "Load More" button (lines 734-746) with an IntersectionObserver-based infinite scroll:

1. Add `useRef` to imports (already has useState, useEffect, useCallback):
   ```typescript
   import { useState, useEffect, useCallback, useRef, Suspense } from 'react'
   ```

2. Add sentinel ref near other state declarations (around line 74):
   ```typescript
   const sentinelRef = useRef<HTMLDivElement>(null)
   ```

3. Add IntersectionObserver useEffect after the existing useEffects (after line ~107):
   ```typescript
   // Infinite scroll observer
   useEffect(() => {
     const sentinel = sentinelRef.current
     if (!sentinel) return

     const observer = new IntersectionObserver(
       (entries) => {
         // Triple-guard: intersecting + has more + not already loading
         if (entries[0].isIntersecting && hasMore && !isLoadingMore) {
           loadMore()
         }
       },
       {
         threshold: 0.1,
         rootMargin: '200px' // Start loading 200px before sentinel visible
       }
     )

     observer.observe(sentinel)

     return () => {
       observer.disconnect()
     }
   }, [hasMore, isLoadingMore]) // loadMore is stable from closure
   ```

4. Replace the Load More button section (lines 734-746) with sentinel element:
   ```typescript
   {/* Infinite scroll sentinel */}
   {hasMore && (
     <div ref={sentinelRef} className="mt-4 py-4 text-center">
       {isLoadingMore && (
         <span className="text-sm text-gray-500 dark:text-gray-400">
           Loading more fillups...
         </span>
       )}
     </div>
   )}

   {/* End of list indicator */}
   {!hasMore && displayFillups.length > 20 && (
     <div className="mt-4 py-2 text-center text-sm text-gray-500 dark:text-gray-400">
       All fillups loaded
     </div>
   )}
   ```

Key patterns from research:
- Use `observer.disconnect()` in cleanup (not just unobserve)
- Triple-guard pattern prevents duplicate API calls
- `rootMargin: '200px'` preloads before user reaches bottom
- Existing `loadMore()` function needs no changes
  </action>
  <verify>
1. Build passes: `npm run build`
2. Manual test: Navigate to a vehicle's fillup page, scroll down - more fillups should load automatically
3. No "Load More" button visible
4. Network tab shows single API call per scroll trigger (no duplicates)
  </verify>
  <done>
- Scrolling to bottom of fillup list automatically loads more
- No duplicate network requests during scroll
- Loading indicator shows while fetching
- "All fillups loaded" appears when no more data
  </done>
</task>

<task type="auto">
  <name>Task 2: Add accessibility enhancements and offline indicator</name>
  <files>src/app/vehicles/[id]/fillups/page.tsx</files>
  <action>
Add accessibility features and offline cache limit indicator:

1. Add ARIA live region after the filter section (around line 532, before Stats Summary):
   ```typescript
   {/* Screen reader announcements for infinite scroll */}
   <div aria-live="polite" aria-atomic="true" className="sr-only">
     {isLoadingMore && "Loading more fillups"}
     {!hasMore && displayFillups.length > 20 && "All fillups loaded"}
   </div>
   ```

2. Add skip link at the start of the fillup list section (inside the else branch of the ternary, before `<div className="space-y-3">`):
   ```typescript
   {/* Skip link for keyboard users */}
   {displayFillups.length > 20 && (
     <a
       href="#add-fillup-section"
       className="sr-only focus:not-sr-only focus:absolute focus:top-20 focus:left-4 focus:z-50 focus:bg-white focus:dark:bg-gray-800 focus:px-4 focus:py-2 focus:shadow-lg focus:rounded-md focus:text-blue-600 focus:dark:text-blue-400"
     >
       Skip to top
     </a>
   )}
   ```

3. Add id to the Add Fillup button section (around line 395) for skip link target:
   ```typescript
   <div id="add-fillup-section" className="mb-6 flex items-center gap-4">
   ```

4. Add offline cache limit indicator. After the "All fillups loaded" indicator, add:
   ```typescript
   {/* Offline cache limit indicator */}
   {!isOnline && !hasMore && fillups.length <= 10 && fillups.length > 0 && (
     <div className="mt-4 py-2 text-center">
       <p className="text-sm text-amber-600 dark:text-amber-400">
         Showing {fillups.length} most recent fillups (offline)
       </p>
       <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
         Connect to load full history
       </p>
     </div>
   )}
   ```

5. Add smooth scroll to top when filters change. In the `applyDateFilter` function (around line 162), add:
   ```typescript
   function applyDateFilter(start: string, end: string, filterName: string | null) {
     setStartDate(start)
     setEndDate(end)
     setActiveFilter(filterName)
     setFillups([])
     setNextCursor(null)
     setIsLoading(true)
     fetchFillups(undefined, start, end)
     // Scroll to top when filter applied
     window.scrollTo({ top: 0, behavior: 'smooth' })
   }
   ```
  </action>
  <verify>
1. Build passes: `npm run build`
2. Screen reader test: Use VoiceOver/NVDA to navigate - should announce "Loading more fillups" when loading
3. Keyboard test: Tab through page - skip link appears on focus after >20 fillups
4. Offline test: Go offline in DevTools, reload page - should see "Showing X most recent fillups (offline)" if <=10 fillups
5. Filter test: Apply a filter - page should scroll to top smoothly
  </verify>
  <done>
- ARIA live region announces loading state to screen readers
- Skip link visible on keyboard focus (after >20 fillups)
- Skip link navigates to top of page
- Offline cache limit message shows when offline with <=10 fillups
- Page scrolls to top when filters applied
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` - no TypeScript errors
2. `npm run lint` - no linting errors
3. Manual end-to-end test:
   - Navigate to vehicle fillups page
   - Scroll down - more fillups load automatically (no button)
   - Network tab shows one request per load (no duplicates)
   - Screen reader announces loading state
   - Tab key shows skip link after >20 fillups
   - Toggle offline mode - see cache limit message
   - Apply filter - page scrolls to top
</verification>

<success_criteria>
- Infinite scroll replaces "Load More" button
- No duplicate API calls during scroll
- Screen reader users hear loading announcements
- Keyboard users can skip fillup list with focus-visible skip link
- Offline users see limited history indicator
- Filters scroll page to top
- All existing functionality preserved (pending fillups, delete, edit, expand)
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-infinite-scroll-on-vehicles-fillups-page/11.1-01-SUMMARY.md`
</output>
